name: Atualizar Estat√≠sticas de C√≥digo

on:
  schedule:
    - cron: '0 0 * * 0'  # Executa todo domingo √† meia-noite
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configurar ambiente
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Clonar e analisar reposit√≥rios
        run: |
          mkdir -p repos

          repositories=(
            "Agenda_Avaliacoes_Academicas"
            "Compression_Manager"
            "Eisenhower_Task_Organizer"
            "Programa_Urna_Eletronica"
            "Dashboard_Streamlit-Plotly-Pandas_Management"
            "Dashboard_Streamlit-Plotly-Pandas_Pareto-Diagram_ABC-Curve"
            "Dashboard_TkInter_Pareto-Diagram_ABC-Curve"
            "sloth-highlander-theme-1"
            "fernandoncidade"
            "Dashboard_Taipy"
            "File_Manager"
            "Programa_Matriz_NM"
            "Programa_Todos_Tipos_Matrizes"
            "Programa_Quociente_Resto"
            "Programa_Multiplo"
            "Programa_Media_Aritmetica"
            "Programa_Determinar_Maior_Inteiro"
            "Linceu_Lighthouse"
            "Economia_APP"
            "Lumen"
          )

          total_lines=0
          total_commits=0
          total_horas=0

          echo "| Reposit√≥rio | Linguagem | Horas Estimadas | Linhas | Commits | Produtividade |" > stats_temp.md
          echo "|-------------|-----------|-----------------|--------|---------|---------------|" >> stats_temp.md

          for repo in "${repositories[@]}"; do
            echo "Processando reposit√≥rio: $repo"
            git clone https://github.com/fernandoncidade/$repo repos/$repo 2>/dev/null || {
              echo "Erro ao clonar $repo, pulando..."
              continue
            }
            cd repos/$repo

            cloc_output=$(cloc --exclude-dir=node_modules,.git --quiet --csv . 2>/dev/null)
            lines=$(echo "$cloc_output" | awk -F',' 'NR>1 {sum += $5} END {print sum+0}')
            lines=${lines:-0}
            linguagem=$(echo "$cloc_output" | awk -F',' 'NR>1 && $5>0 {if ($5>max) {max=$5; lang=$2}} END {print lang}')
            linguagem=${linguagem:-"N/A"}
            commits=$(git rev-list --count HEAD 2>/dev/null || echo 0)
            commits=${commits:-0}

            case "$linguagem" in
              "Python") taxa_base=15 ;;
              "JavaScript") taxa_base=20 ;;
              "C++") taxa_base=10 ;;
              "HTML") taxa_base=30 ;;
              "CSS") taxa_base=25 ;;
              "Java") taxa_base=12 ;;
              "Markdown") taxa_base=35 ;;
              *) taxa_base=18 ;;
            esac

            case "$repo" in
              *"Monitor"*) complexidade=1.2 ;;
              *"Dashboard"*) complexidade=0.9 ;;
              *"Compression"*) complexidade=1.3 ;;
              "fernandoncidade") complexidade=0.8 ;;
              *) complexidade=1.0 ;;
            esac

            if [ $lines -gt 5000 ]; then
              tamanho_ajuste=1.2
            elif [ $lines -gt 2000 ]; then
              tamanho_ajuste=1.1
            else
              tamanho_ajuste=1.0
            fi

            taxa_efetiva=$(awk "BEGIN {print $taxa_base / ($complexidade * $tamanho_ajuste)}")
            horas=$(awk "BEGIN {h = $lines / $taxa_efetiva; print (h > 10) ? h : 10}")
            horas=$(printf "%.1f" $horas)
            produtividade=$(awk "BEGIN {printf \"%.2f\", $lines / $horas}")

            echo "| $repo | $linguagem | ${horas}h | $lines | $commits | $produtividade l/h |" >> ../../stats_temp.md

            repo_env=$(echo "$repo" | sed -e 's/-/_/g' -e 's/\./_/g' | tr '[:lower:]' '[:upper:]')
            echo "${repo_env}_LINES=$lines" >> $GITHUB_ENV
            echo "${repo_env}_COMMITS=$commits" >> $GITHUB_ENV
            echo "${repo_env}_HOURS=$horas" >> $GITHUB_ENV
            echo "${repo_env}_PROD=$produtividade" >> $GITHUB_ENV

            total_lines=$((total_lines + lines))
            total_commits=$((total_commits + commits))
            total_horas=$(awk "BEGIN {printf \"%.1f\", $total_horas + $horas}")

            cd ../..
            echo "Reposit√≥rio $repo processado: $lines linhas, $commits commits, $horas horas estimadas"
          done

          echo "TOTAL_LINES=$total_lines" >> $GITHUB_ENV
          echo "TOTAL_COMMITS=$total_commits" >> $GITHUB_ENV
          echo "TOTAL_HOURS=$total_horas" >> $GITHUB_ENV

          echo "| **TOTAL** | - | ${total_horas}h | $total_lines | $total_commits | - |" >> stats_temp.md
          mv stats_temp.md stats.md

      - name: Atualizar README
        run: |
          # Criar backup do README atual
          cp README.md README.backup.md
          
          # Atualizar totais
          sed -i "s/### üïí Total de Tempo Trabalhado: [0-9.]*$/### üïí Total de Tempo Trabalhado: ${{ env.TOTAL_HOURS }}/" README.md
          sed -i "s/### üìù Total de Linhas Escritas: [0-9]*$/### üìù Total de Linhas Escritas: ${{ env.TOTAL_LINES }}/" README.md
          sed -i "s/### üíª Total de Commits: [0-9]*$/### üíª Total de Commits: ${{ env.TOTAL_COMMITS }}/" README.md

          # Atualizar reposit√≥rios individuais
          sed -i "s/| üìÖ \*\*Agenda [^|]* | Python | [0-9.]* | [0-9]* | [0-9]* | [0-9.]* |/| üìÖ **Agenda Avalia√ß√µes Acad√™micas** | Python | ${{ env.AGENDA_AVALIACOES_ACADEMICAS_HOURS }} | ${{ env.AGENDA_AVALIACOES_ACADEMICAS_LINES }} | ${{ env.AGENDA_AVALIACOES_ACADEMICAS_COMMITS }} | ${{ env.AGENDA_AVALIACOES_ACADEMICAS_PROD }} |/" README.md
          
          sed -i "s/| üóúÔ∏è \*\*Compression Manager\*\* | Python | [0-9.]* | [0-9]* | [0-9]* | [0-9.]* |/| üóúÔ∏è **Compression Manager** | Python | ${{ env.COMPRESSION_MANAGER_HOURS }} | ${{ env.COMPRESSION_MANAGER_LINES }} | ${{ env.COMPRESSION_MANAGER_COMMITS }} | ${{ env.COMPRESSION_MANAGER_PROD }} |/" README.md
          
          sed -i "s/| üìã \*\*Eisenhower [^|]* | Python | [0-9.]* | [0-9]* | [0-9]* | [0-9.]* |/| üìã **Eisenhower Task Organizer** | Python | ${{ env.EISENHOWER_TASK_ORGANIZER_HOURS }} | ${{ env.EISENHOWER_TASK_ORGANIZER_LINES }} | ${{ env.EISENHOWER_TASK_ORGANIZER_COMMITS }} | ${{ env.EISENHOWER_TASK_ORGANIZER_PROD }} |/" README.md
          
          sed -i "s/| üó≥Ô∏è \*\*Programa Urna [^|]* | C++ | [0-9.]* | [0-9]* | [0-9]* | [0-9.]* |/| üó≥Ô∏è **Programa Urna Eletr√¥nica** | C++ | ${{ env.PROGRAMA_URNA_ELETRONICA_HOURS }} | ${{ env.PROGRAMA_URNA_ELETRONICA_LINES }} | ${{ env.PROGRAMA_URNA_ELETRONICA_COMMITS }} | ${{ env.PROGRAMA_URNA_ELETRONICA_PROD }} |/" README.md

          # Verificar se houve mudan√ßas
          if diff README.md README.backup.md > /dev/null; then
            echo "Nenhuma mudan√ßa detectada no README"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "Mudan√ßas detectadas no README"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Commit e push das altera√ß√µes
        if: env.HAS_CHANGES == 'true'
        run: |
          git add README.md stats.md
          git status
          git diff --cached
          git commit -m "Atualiza estat√≠sticas de c√≥digo [skip ci]" || {
            echo "Falha no commit"
            exit 1
          }
          git push || {
            echo "Falha no push"
            exit 1
          }
          echo "Push realizado com sucesso!"

      - name: Debug - Mostrar estat√≠sticas
        if: always()
        run: |
          echo "=== Estat√≠sticas Coletadas ==="
          echo "Total Lines: ${{ env.TOTAL_LINES }}"
          echo "Total Commits: ${{ env.TOTAL_COMMITS }}"
          echo "Total Hours: ${{ env.TOTAL_HOURS }}"
          echo "=== Conte√∫do do stats.md ==="
          cat stats.md || echo "Arquivo stats.md n√£o encontrado"
