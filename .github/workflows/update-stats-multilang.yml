name: Atualizar Estatísticas de Código

on:
  schedule:
    - cron: '0 0 * * 0'  # UTC (domingo 00:00)
  workflow_dispatch:
  repository_dispatch:
    types: [update-stats]

concurrency:
  group: update-stats
  cancel-in-progress: true

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # NÃO fixar ref: main. Deixe pegar o default branch do repo.
      - uses: actions/checkout@v4
        with:
          path: main-repo
          fetch-depth: 0

      - name: Configurar ambiente
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Clonar e analisar repositórios
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p repos
          stats_file="$GITHUB_WORKSPACE/main-repo/stats.md"

          repositories=(
            "Agenda_Avaliacoes_Academicas"
            "Compression_Manager"
            "Eisenhower_Organizer"
            "Programa_Urna_Eletronica"
            "Dashboard_Streamlit-Plotly-Pandas_Management"
            "Dashboard_Streamlit-Plotly-Pandas_Pareto-Diagram_ABC-Curve"
            "Dashboard_TkInter_Pareto-Diagram_ABC-Curve"
            "sloth-highlander-theme-1"
            "fernandoncidade"
            "Dashboard_Taipy"
            "File_Manager"
            "Programa_Matriz_NM"
            "Programa_Todos_Tipos_Matrizes"
            "Programa_Quociente_Resto"
            "Programa_Multiplo"
            "Programa_Media_Aritmetica"
            "Programa_Determinar_Maior_Inteiro"
            "Linceu_Lighthouse"
            "Economia_APP"
            "Lumen"
            "Compare_Following_Follower"
          )

          total_lines=0
          total_commits=0
          total_horas=0

          {
            echo "| Repositório | Linguagem | Horas Estimadas | Linhas | Commits | Produtividade |"
            echo "|-------------|-----------|-----------------|--------|---------|---------------|"
          } > "$stats_file"

          for repo in "${repositories[@]}"; do
            echo "Processando repositório: $repo"

            if ! git clone "https://github.com/fernandoncidade/$repo" "repos/$repo"; then
              echo "Falha ao clonar $repo (pulando)"
              continue
            fi

            cd "repos/$repo"

            cloc_output="$(cloc --exclude-dir=node_modules,.git --quiet --csv . || true)"
            lines="$(echo "$cloc_output" | awk -F',' 'NR>1 {sum += $5} END {print sum+0}')"
            lines="${lines:-0}"

            # Linguagem dominante (ignorando SUM)
            linguagem="$(echo "$cloc_output" | awk -F',' 'NR>1 && $2!="SUM" && $5>0 {if ($5>max) {max=$5; lang=$2}} END {print (lang=="" ? "N/A" : lang)}')"
            linguagem="${linguagem:-N/A}"

            commits="$(git rev-list --count HEAD 2>/dev/null || echo 0)"
            commits="${commits:-0}"

            case "$linguagem" in
              "Python") taxa_base=15 ;;
              "JavaScript") taxa_base=20 ;;
              "C++") taxa_base=10 ;;
              "HTML") taxa_base=30 ;;
              "CSS") taxa_base=25 ;;
              "Java") taxa_base=12 ;;
              "Markdown") taxa_base=35 ;;
              *) taxa_base=18 ;;
            esac

            case "$repo" in
              *"Monitor"*) complexidade=1.2 ;;
              *"Dashboard"*) complexidade=0.9 ;;
              *"Compression"*) complexidade=1.3 ;;
              "fernandoncidade") complexidade=0.8 ;;
              *) complexidade=1.0 ;;
            esac

            if [ "$lines" -gt 5000 ]; then
              tamanho_ajuste=1.2
            elif [ "$lines" -gt 2000 ]; then
              tamanho_ajuste=1.1
            else
              tamanho_ajuste=1.0
            fi

            taxa_efetiva="$(awk "BEGIN {print $taxa_base / ($complexidade * $tamanho_ajuste)}")"
            horas="$(awk "BEGIN {h = $lines / $taxa_efetiva; print (h > 10) ? h : 10}")"
            horas="$(printf "%.1f" "$horas")"
            produtividade="$(awk "BEGIN {printf \"%.2f\", $lines / $horas}")"

            echo "| $repo | $linguagem | ${horas}h | $lines | $commits | $produtividade l/h |" >> "$stats_file"

            # Repo env robusto: manter só A-Z0-9_
            repo_env="$(echo "$repo" \
              | sed -e 's/[^[:alnum:]]/_/g' \
              | tr '[:lower:]' '[:upper:]')"

            {
              echo "${repo_env}_LINES=$lines"
              echo "${repo_env}_COMMITS=$commits"
              echo "${repo_env}_HOURS=$horas"
              echo "${repo_env}_PROD=$produtividade"
            } >> "$GITHUB_ENV"

            total_lines=$((total_lines + lines))
            total_commits=$((total_commits + commits))
            total_horas="$(awk "BEGIN {printf \"%.1f\", $total_horas + $horas}")"

            cd "$GITHUB_WORKSPACE"
            echo "Repositório $repo processado: $lines linhas, $commits commits, $horas horas estimadas"
          done

          {
            echo "TOTAL_LINES=$total_lines"
            echo "TOTAL_COMMITS=$total_commits"
            echo "TOTAL_HOURS=$total_horas"
          } >> "$GITHUB_ENV"

          echo "| **TOTAL** | - | ${total_horas}h | $total_lines | $total_commits | - |" >> "$stats_file"

      - name: Atualizar README (idempotente)
        shell: bash
        run: |
          set -euo pipefail
          cd main-repo

          replace_marker () {
            local marker="$1"
            local value="$2"
            perl -i -pe "s/(?:\\b[0-9]+(?:\\.[0-9]+)?\\s*h?\\s*)?<!--\\s*\\Q${marker}\\E\\s*-->/${value} <!-- ${marker} -->/g" README.md
          }

          replace_marker "TOTAL_LINES_PLACEHOLDER" "${{ env.TOTAL_LINES }}"
          replace_marker "TOTAL_COMMITS_PLACEHOLDER" "${{ env.TOTAL_COMMITS }}"
          replace_marker "TOTAL_HOURS_PLACEHOLDER" "${{ env.TOTAL_HOURS }}h"

          replace_marker "AGENDA_LINES" "${{ env.AGENDA_AVALIACOES_ACADEMICAS_LINES }}"
          replace_marker "AGENDA_COMMITS" "${{ env.AGENDA_AVALIACOES_ACADEMICAS_COMMITS }}"
          replace_marker "AGENDA_HOURS" "${{ env.AGENDA_AVALIACOES_ACADEMICAS_HOURS }}h"
          replace_marker "AGENDA_PROD" "${{ env.AGENDA_AVALIACOES_ACADEMICAS_PROD }}"

          replace_marker "COMPRESSION_LINES" "${{ env.COMPRESSION_MANAGER_LINES }}"
          replace_marker "COMPRESSION_COMMITS" "${{ env.COMPRESSION_MANAGER_COMMITS }}"
          replace_marker "COMPRESSION_HOURS" "${{ env.COMPRESSION_MANAGER_HOURS }}h"
          replace_marker "COMPRESSION_PROD" "${{ env.COMPRESSION_MANAGER_PROD }}"

          replace_marker "EISENHOWER_LINES" "${{ env.EISENHOWER_ORGANIZER_LINES }}"
          replace_marker "EISENHOWER_COMMITS" "${{ env.EISENHOWER_ORGANIZER_COMMITS }}"
          replace_marker "EISENHOWER_HOURS" "${{ env.EISENHOWER_ORGANIZER_HOURS }}h"
          replace_marker "EISENHOWER_PROD" "${{ env.EISENHOWER_ORGANIZER_PROD }}"

          replace_marker "URNA_LINES" "${{ env.PROGRAMA_URNA_ELETRONICA_LINES }}"
          replace_marker "URNA_COMMITS" "${{ env.PROGRAMA_URNA_ELETRONICA_COMMITS }}"
          replace_marker "URNA_HOURS" "${{ env.PROGRAMA_URNA_ELETRONICA_HOURS }}h"
          replace_marker "URNA_PROD" "${{ env.PROGRAMA_URNA_ELETRONICA_PROD }}"

          replace_marker "MANEGEMENT_LINES" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_MANAGEMENT_LINES }}"
          replace_marker "MANEGEMENT_COMMITS" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_MANAGEMENT_COMMITS }}"
          replace_marker "MANEGEMENT_HOURS" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_MANAGEMENT_HOURS }}h"
          replace_marker "MANEGEMENT_PROD" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_MANAGEMENT_PROD }}"

          replace_marker "STREAMLIT_LINES" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_PARETO_DIAGRAM_ABC_CURVE_LINES }}"
          replace_marker "STREAMLIT_COMMITS" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_PARETO_DIAGRAM_ABC_CURVE_COMMITS }}"
          replace_marker "STREAMLIT_HOURS" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_PARETO_DIAGRAM_ABC_CURVE_HOURS }}h"
          replace_marker "STREAMLIT_PROD" "${{ env.DASHBOARD_STREAMLIT_PLOTLY_PANDAS_PARETO_DIAGRAM_ABC_CURVE_PROD }}"

          replace_marker "PARETO_LINES" "${{ env.DASHBOARD_TKINTER_PARETO_DIAGRAM_ABC_CURVE_LINES }}"
          replace_marker "PARETO_COMMITS" "${{ env.DASHBOARD_TKINTER_PARETO_DIAGRAM_ABC_CURVE_COMMITS }}"
          replace_marker "PARETO_HOURS" "${{ env.DASHBOARD_TKINTER_PARETO_DIAGRAM_ABC_CURVE_HOURS }}h"
          replace_marker "PARETO_PROD" "${{ env.DASHBOARD_TKINTER_PARETO_DIAGRAM_ABC_CURVE_PROD }}"

          replace_marker "TAIPY_LINES" "${{ env.DASHBOARD_TAIPY_LINES }}"
          replace_marker "TAIPY_COMMITS" "${{ env.DASHBOARD_TAIPY_COMMITS }}"
          replace_marker "TAIPY_HOURS" "${{ env.DASHBOARD_TAIPY_HOURS }}h"
          replace_marker "TAIPY_PROD" "${{ env.DASHBOARD_TAIPY_PROD }}"

          replace_marker "LIGHTHOUSE_LINES" "${{ env.LINCEU_LIGHTHOUSE_LINES }}"
          replace_marker "LIGHTHOUSE_COMMITS" "${{ env.LINCEU_LIGHTHOUSE_COMMITS }}"
          replace_marker "LIGHTHOUSE_HOURS" "${{ env.LINCEU_LIGHTHOUSE_HOURS }}h"
          replace_marker "LIGHTHOUSE_PROD" "${{ env.LINCEU_LIGHTHOUSE_PROD }}"

          replace_marker "SLOTH_LINES" "${{ env.SLOTH_HIGHLANDER_THEME_1_LINES }}"
          replace_marker "SLOTH_COMMITS" "${{ env.SLOTH_HIGHLANDER_THEME_1_COMMITS }}"
          replace_marker "SLOTH_HOURS" "${{ env.SLOTH_HIGHLANDER_THEME_1_HOURS }}h"
          replace_marker "SLOTH_PROD" "${{ env.SLOTH_HIGHLANDER_THEME_1_PROD }}"

          replace_marker "README_LINES" "${{ env.FERNANDONCIDADE_LINES }}"
          replace_marker "README_COMMITS" "${{ env.FERNANDONCIDADE_COMMITS }}"
          replace_marker "README_HOURS" "${{ env.FERNANDONCIDADE_HOURS }}h"
          replace_marker "README_PROD" "${{ env.FERNANDONCIDADE_PROD }}"

          replace_marker "FILEMANAGER_LINES" "${{ env.FILE_MANAGER_LINES }}"
          replace_marker "FILEMANAGER_COMMITS" "${{ env.FILE_MANAGER_COMMITS }}"
          replace_marker "FILEMANAGER_HOURS" "${{ env.FILE_MANAGER_HOURS }}h"
          replace_marker "FILEMANAGER_PROD" "${{ env.FILE_MANAGER_PROD }}"

          replace_marker "MATRIZNM_LINES" "${{ env.PROGRAMA_MATRIZ_NM_LINES }}"
          replace_marker "MATRIZNM_COMMITS" "${{ env.PROGRAMA_MATRIZ_NM_COMMITS }}"
          replace_marker "MATRIZNM_HOURS" "${{ env.PROGRAMA_MATRIZ_NM_HOURS }}h"
          replace_marker "MATRIZNM_PROD" "${{ env.PROGRAMA_MATRIZ_NM_PROD }}"

          replace_marker "MATRIZES_LINES" "${{ env.PROGRAMA_TODOS_TIPOS_MATRIZES_LINES }}"
          replace_marker "MATRIZES_COMMITS" "${{ env.PROGRAMA_TODOS_TIPOS_MATRIZES_COMMITS }}"
          replace_marker "MATRIZES_HOURS" "${{ env.PROGRAMA_TODOS_TIPOS_MATRIZES_HOURS }}h"
          replace_marker "MATRIZES_PROD" "${{ env.PROGRAMA_TODOS_TIPOS_MATRIZES_PROD }}"

          replace_marker "QUOCRESTO_LINES" "${{ env.PROGRAMA_QUOCIENTE_RESTO_LINES }}"
          replace_marker "QUOCRESTO_COMMITS" "${{ env.PROGRAMA_QUOCIENTE_RESTO_COMMITS }}"
          replace_marker "QUOCRESTO_HOURS" "${{ env.PROGRAMA_QUOCIENTE_RESTO_HOURS }}h"
          replace_marker "QUOCRESTO_PROD" "${{ env.PROGRAMA_QUOCIENTE_RESTO_PROD }}"

          replace_marker "MULTIPLO_LINES" "${{ env.PROGRAMA_MULTIPLO_LINES }}"
          replace_marker "MULTIPLO_COMMITS" "${{ env.PROGRAMA_MULTIPLO_COMMITS }}"
          replace_marker "MULTIPLO_HOURS" "${{ env.PROGRAMA_MULTIPLO_HOURS }}h"
          replace_marker "MULTIPLO_PROD" "${{ env.PROGRAMA_MULTIPLO_PROD }}"

          replace_marker "MEDIAARIT_LINES" "${{ env.PROGRAMA_MEDIA_ARITMETICA_LINES }}"
          replace_marker "MEDIAARIT_COMMITS" "${{ env.PROGRAMA_MEDIA_ARITMETICA_COMMITS }}"
          replace_marker "MEDIAARIT_HOURS" "${{ env.PROGRAMA_MEDIA_ARITMETICA_HOURS }}h"
          replace_marker "MEDIAARIT_PROD" "${{ env.PROGRAMA_MEDIA_ARITMETICA_PROD }}"

          replace_marker "MAIORINT_LINES" "${{ env.PROGRAMA_DETERMINAR_MAIOR_INTEIRO_LINES }}"
          replace_marker "MAIORINT_COMMITS" "${{ env.PROGRAMA_DETERMINAR_MAIOR_INTEIRO_COMMITS }}"
          replace_marker "MAIORINT_HOURS" "${{ env.PROGRAMA_DETERMINAR_MAIOR_INTEIRO_HOURS }}h"
          replace_marker "MAIORINT_PROD" "${{ env.PROGRAMA_DETERMINAR_MAIOR_INTEIRO_PROD }}"

          replace_marker "ECONOMIA_LINES" "${{ env.ECONOMIA_APP_LINES }}"
          replace_marker "ECONOMIA_COMMITS" "${{ env.ECONOMIA_APP_COMMITS }}"
          replace_marker "ECONOMIA_HOURS" "${{ env.ECONOMIA_APP_HOURS }}h"
          replace_marker "ECONOMIA_PROD" "${{ env.ECONOMIA_APP_PROD }}"

          replace_marker "LUMEN_LINES" "${{ env.LUMEN_LINES }}"
          replace_marker "LUMEN_COMMITS" "${{ env.LUMEN_COMMITS }}"
          replace_marker "LUMEN_HOURS" "${{ env.LUMEN_HOURS }}h"
          replace_marker "LUMEN_PROD" "${{ env.LUMEN_PROD }}"

          replace_marker "COMPARE_LINES" "${{ env.COMPARE_LINES }}"
          replace_marker "COMPARE_COMMITS" "${{ env.COMPARE_COMMITS }}"
          replace_marker "COMPARE_HOURS" "${{ env.COMPARE_HOURS }}h"
          replace_marker "COMPARE_PROD" "${{ env.COMPARE_PROD }}"

          git diff -- README.md stats.md || true

      - name: Sanity check (branch e status)
        shell: bash
        run: |
          set -euo pipefail
          cd main-repo
          echo "Branch atual:"
          git rev-parse --abbrev-ref HEAD
          echo "Status:"
          git status --porcelain=v1

      - name: Commit e push das alterações
        run: |
          set -euo pipefail
          cd main-repo

          # Push para o MESMO branch do checkout (não fixar main)
          branch="$(git rev-parse --abbrev-ref HEAD)"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add README.md stats.md
          git commit -m "Atualiza estatísticas de código [skip ci]" || echo "No changes to commit"
          git push origin "$branch"